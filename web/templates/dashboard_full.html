<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>IntelliSniff — Центр мониторинга трафика</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="{{ url_for('static', path='app.js') }}"></script>
</head>
<body>
  <div id="authOverlay" class="auth-overlay hidden">
    <form id="authForm" class="auth-card">
      <h2>Вход в IntelliSniff</h2>
      <p class="auth-subtitle">Используйте учётную запись администратора (HTTP Basic).</p>
      <label>
        Логин
        <input type="text" id="authLogin" autocomplete="username" required>
      </label>
      <label>
        Пароль
        <input type="password" id="authPassword" autocomplete="current-password" required>
      </label>
      <button type="submit">Войти</button>
      <p class="auth-hint">По умолчанию: <code>admin / changeme</code>. Настройте переменные окружения <code>TA_USER</code>, <code>TA_PASS</code>.</p>
    </form>
  </div>

  <header class="page-header">
    <div>
      <h1>IntelliSniff</h1>
      <p class="subtitle">Интерактивная панель анализа сетевых потоков</p>
    </div>
    <div class="header-meta">
      <div id="statusBadge" class="status-badge status-idle">Ожидание</div>
      <div class="user-meta">Ваш IP: {{ request.client.host }}</div>
    </div>
  </header>

  <section class="controls-card">
    <div class="controls-grid">
      <label>
        Интерфейс
        <select id="iface">
          <option value="">Авто</option>
        </select>
      </label>
      <label>
        BPF-фильтр
        <input id="bpf" placeholder="tcp port 80">
      </label>
      <label>
        Таймаут потока (с)
        <input id="flowTimeout" type="number" min="1" max="600" step="1" value="30">
      </label>
      <label class="checkbox">
        <input type="checkbox" id="use_nfstream"> Глубокий анализ NFStream
      </label>
      <div class="buttons">
        <button id="startBtn" class="primary">Запустить захват</button>
        <button id="stopBtn" class="ghost">Остановить</button>
      </div>
      <div class="buttons">
        <button id="trainBtn" class="ghost">Переобучить модель</button>
        <button id="csvBtn" class="ghost">Экспорт CSV</button>
        <button id="pdfBtn" class="ghost">Экспорт PDF</button>
      </div>
    </div>
    <div id="statusDetails" class="status-details"></div>
  </section>

  <section class="cards-grid">
    <div class="info-card">
      <h3>Всего потоков</h3>
      <div class="metric" id="totalFlows">0</div>
      <span class="hint">Количество потоков за последнюю сессию</span>
    </div>
    <div class="info-card">
      <h3>Подозрительные</h3>
      <div class="metric warning" id="suspiciousFlows">0</div>
      <span class="hint">Метки, отличные от "web" / "benign"</span>
    </div>
    <div class="info-card">
      <h3>Средняя пропускная способность</h3>
      <div class="metric" id="bandwidth">0 КБ/с</div>
      <span class="hint">По последним потокам</span>
    </div>
    <div class="info-card">
      <h3>Последний поток</h3>
      <div class="metric" id="lastFlowLabel">—</div>
      <span class="hint" id="lastFlowSummary">Ожидание данных</span>
    </div>
  </section>

  <section class="charts-grid">
    <div class="chart-card">
      <div class="chart-header">
        <h3>Распределение меток</h3>
        <select id="labelFilter">
          <option value="all" selected>Все метки</option>
        </select>
      </div>
      <canvas id="labelsChart" width="420" height="260"></canvas>
    </div>
    <div class="chart-card">
      <h3>Интенсивность пакетов</h3>
      <canvas id="trafficChart" width="420" height="260"></canvas>
    </div>
    <div class="chart-card">
      <h3>Топ направлений</h3>
      <canvas id="destChart" width="420" height="260"></canvas>
    </div>
  </section>

  <section class="table-card">
    <div class="table-header">
      <h3>Последние потоки</h3>
      <div class="table-controls">
        <label>Поиск <input type="search" id="tableSearch" placeholder="IP, порт или метка"></label>
        <span id="tableCounter">0 записей</span>
      </div>
    </div>
    <div class="table-wrapper">
      <table id="flowsTable">
        <thead>
          <tr>
            <th>Время</th>
            <th>Источник</th>
            <th>Назначение</th>
            <th>Порты</th>
            <th>Протокол</th>
            <th>Метка</th>
            <th>Вероятность</th>
            <th>Пакеты</th>
            <th>Байты</th>
            <th>Сводка</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <footer class="page-footer">
    <div>
      Версия панели IntelliSniff · NFStream: <span id="nfStatus">—</span>
    </div>
    <div>
      При возникновении проблем проверьте настройки прав доступа к сетевому интерфейсу и модель <code>data/model.joblib</code>.
    </div>
  </footer>
</body>
</html>
